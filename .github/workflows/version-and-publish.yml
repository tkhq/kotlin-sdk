name: Version, Tag Release Branch, and Publish (Kotlin)

on:
  workflow_dispatch: # allows manual invocation
  push:
    tags:
      - "v*.*.*"   # e.g. v1.2.3

permissions:
  contents: write
  packages: write
  id-token: write

env:
  # Make Gradle a bit chattier/faster and show stacktraces if needed
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=2"
  CENTRAL_RELEASE: "true"
  CI: "true"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      has_changesets: ${{ steps.detect.outputs.has_changesets }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Set up Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: "24"

      - name: Set up Android SDK (cmdline)
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Install Android platforms/build-tools
        run: |
          sdkmanager --install "platforms;android-36" "build-tools;36.0.0" || true
          yes | sdkmanager --licenses || true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@748248ddd2a24f49513d8f472f81c3a07d4d50e1 #v4.4.4

      - name: Bump Gradle/JVM memory
        run: |
          mkdir -p ~/.gradle
          cat >> ~/.gradle/gradle.properties <<'EOF'
            org.gradle.jvmargs=-Xmx5g -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError
            org.gradle.parallel=false
            org.gradle.workers.max=1
            kotlin.daemon.jvmargs=-Xmx2g
            org.gradle.caching=true
          EOF

      - name: Check for pending changesets
        id: detect
        run: |
          echo "Checking for pending changesets..."
          set +e
          ./gradlew --no-daemon changesetsStatus -q > status.txt
          cat status.txt
          if grep -qi "Pending changesets:" status.txt; then
            echo "has_changesets=true" >> "$GITHUB_OUTPUT"
            echo "Changesets found."
            exit 0
          else
            echo "has_changesets=false" >> "$GITHUB_OUTPUT"
            echo "No pending changesets."
            exit 0
          fi

      - name: Build (sanity)
        if: ${{ steps.detect.outputs.has_changesets == 'true' }}
        run: ./gradlew --no-daemon\:packages:encoding:build\:packages:crypto:build\:packages:http:build\:packages:passkey:build\:packages:stamper:build\:packages:types:build\:packages:sdk-kotlin:build

  version-and-rebuild:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.outputs.has_changesets == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Set up Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: "24"

      - name: Set up Android SDK (cmdline)
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Install Android platforms/build-tools
        run: |
          sdkmanager --install "platforms;android-36" "build-tools;36.0.0" || true
          yes | sdkmanager --licenses || true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@748248ddd2a24f49513d8f472f81c3a07d4d50e1 # v4.4.4

      - name: Configure Git User
        run: |
          git config user.name "tkhq-deploy"
          git config user.email "github@turnkey.engineering"

      - name: Create/switch to release branch
        run: |
          git fetch origin
          git checkout -B release/${{ github.ref_name }} origin/release/${{ github.ref_name }} || \
          git checkout -B release/${{ github.ref_name }}

      - name: Version and rebuild packages
        run: |
          ./gradlew --no-daemon changesetsVersion
          ./gradlew --no-daemon build
          ./gradlew --no-daemon changesetsChangelog

      - name: Git status (debug)
        run: |
          git status --short
          ls -la .changeset || true

      - name: Commit versioned changes
        run: |
          git add -A
          git commit -m "chore: release (apply changesets, bump versions, write changelogs)" || echo "No changes to commit"

      - name: Push release branch
        run: git push -u origin release/${{ github.ref_name }}

      - name: Upload release artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: release-artifacts-${{ github.ref_name }}
          path: |
            **/build/libs/**
            **/build/publications/**
            **/pom-default.xml
            **/CHANGELOG.md
          retention-days: 7

  prepare-release:
    runs-on: ubuntu-latest
    needs: version-and-rebuild
    if: ${{ needs.build.outputs.has_changesets == 'true' }}
    steps:
      - name: Checkout release branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: release/${{ github.ref_name }}

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 #v2.2.2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          draft: true
          prerelease: ${{ contains(github.ref_name, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    needs: prepare-release
    if: ${{ needs.build.outputs.has_changesets == 'true' }}
    runs-on:
      group: package-deploy
    environment: production   # TODO: protect with required reviewers (I think this environment already has that but good to double check)

    steps:
      - name: Checkout release branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: release/${{ github.ref_name }}

      - name: Set up Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: "24"

      - name: Set up Android SDK (cmdline)
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Install Android platforms/build-tools
        run: |
          sdkmanager --install "platforms;android-36" "build-tools;36.0.0" || true
          yes | sdkmanager --licenses || true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@748248ddd2a24f49513d8f472f81c3a07d4d50e1 # v4.4.4

      # TODO: Feed Gradle the Central + signing creds, matching our root build.gradle wiring
      - name: Configure publishing credentials
        run: |
          {
            echo "mavenCentralUsername=${{ secrets.MAVEN_CENTRAL_USERNAME }}";
            echo "mavenCentralPassword=${{ secrets.MAVEN_CENTRAL_PASSWORD }}";
          } >> ~/.gradle/gradle.properties

      - name: Import in-memory PGP key (used by Signing plugin)
        env:
          OSSRH_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          test -n "$GPG_PRIVATE_KEY" || { echo "Missing GPG_PRIVATE_KEY"; exit 1; }

      - name: Dry-run publish matrix + local publish (sanity)
        run: |
          ./gradlew --no-daemon printPublishMatrix
          ./gradlew --no-daemon publishSelectedToMavenLocal

      # Real publish to Central (snapshots if version ends with -SNAPSHOT, otherwise release staging flow)
      - name: Publish to Maven Central
        env:
          CENTRAL_RELEASE: "true"
          CI: "true"
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          OSSRH_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
        run: |
          ./gradlew clean --no-daemon publishSelectedToMavenCentral --stacktrace
          
          # Remove publishing creds from ~/.gradle/gradle.properties
          if [ -f ~/.gradle/gradle.properties ]; then
            tmp="$(mktemp)"
            grep -v -E '^[[:space:]]*(mavenCentralUsername|mavenCentralPassword)[[:space:]]*=' \
              ~/.gradle/gradle.properties > "$tmp"
            mv "$tmp" ~/.gradle/gradle.properties
          fi