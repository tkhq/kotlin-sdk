name: Tag Release Branch, and Publish (Kotlin)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (leave empty to auto-generate v{year}.{month}.{counter})'
        required: false
        type: string
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  packages: write

env:
  # Make Gradle a bit chattier/faster and show stacktraces if needed
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=2"
  CENTRAL_RELEASE: "true"
  CI: "true"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          ref: ${{ github.event.repository.default_branch }}

      - name: Set up Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: "24"

      - name: Set up Android SDK (cmdline)
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Install Android platforms/build-tools
        run: |
          sdkmanager --install "platforms;android-36" "build-tools;36.0.0" || true
          yes | sdkmanager --licenses || true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@748248ddd2a24f49513d8f472f81c3a07d4d50e1 #v4.4.4

      - name: Bump Gradle/JVM memory
        run: |
          mkdir -p ~/.gradle
          cat >> ~/.gradle/gradle.properties <<'EOF'
            org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError
            org.gradle.parallel=false
            org.gradle.workers.max=1
            org.gradle.caching=true
          EOF

      - name: Extract or generate version
        id: extract-version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger
            if [[ -n "${{ inputs.version }}" ]]; then
              # Use provided version
              VERSION="${{ inputs.version }}"
            else
              # Auto-generate: v{year}.{month}.{counter}
              YEAR=$(date +%Y)
              MONTH=$(date +%-m)  # No leading zero
              PREFIX="v${YEAR}.${MONTH}."

              # Find highest existing counter for this month
              HIGHEST=$(git tag -l "${PREFIX}*" | sed "s/${PREFIX}//" | sort -n | tail -1)
              if [[ -z "$HIGHEST" ]]; then
                COUNTER=0
              else
                COUNTER=$((HIGHEST + 1))
              fi

              VERSION="${PREFIX}${COUNTER}"
            fi
          else
            # PR trigger - extract from branch name
            VERSION="${GITHUB_HEAD_REF#release/}"
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Version does not match expected format vX.X.X (got: $VERSION)"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Build (sanity)
        run: |
          ./gradlew --no-daemon \
            :packages:encoding:build \
            :packages:crypto:build \
            :packages:types:build \
            :packages:stamper:assembleRelease \
            :packages:http:assembleRelease \
            :packages:passkey:assembleRelease \
            :packages:sdk-kotlin:assembleRelease

  prepare-release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout release branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 #v2.2.2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: Release ${{ needs.build.outputs.version }}
          generate_release_notes: true
          draft: true
          prerelease: ${{ contains(needs.build.outputs.version, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    needs: prepare-release
    runs-on:
      group: package-deploy
    environment: production

    steps:
      - name: Checkout release branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: "24"

      - name: Set up Android SDK (cmdline)
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Install Android platforms/build-tools
        run: |
          sdkmanager --install "platforms;android-36" "build-tools;36.0.0" || true
          yes | sdkmanager --licenses || true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@748248ddd2a24f49513d8f472f81c3a07d4d50e1 # v4.4.4

      - name: Bump Gradle/JVM memory
        run: |
          mkdir -p ~/.gradle
          cat >> ~/.gradle/gradle.properties <<'EOF'
            org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError
            org.gradle.parallel=false
            org.gradle.workers.max=1
            org.gradle.caching=true
          EOF

      - name: Import in-memory PGP key (used by Signing plugin)
        env:
          OSSRH_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_FINGERPRINT: ${{ secrets.GPG_FINGERPRINT }}
        run: |
          test -n "$GPG_PRIVATE_KEY" || { echo "Missing GPG_PRIVATE_KEY"; exit 1; }
          test -n "$GPG_PASSPHRASE" || { echo "Missing GPG_PASSPHRASE"; exit 1; }
          test -n "$GPG_FINGERPRINT" || { echo "Missing GPG_FINGERPRINT"; exit 1; }

      - name: Dry-run publish matrix + local publish (sanity)
        env:
          CENTRAL_RELEASE: "false"
          CI: "true"
        run: |
          ./gradlew --no-daemon printPublishMatrix
          ./gradlew --no-daemon publishSelectedToMavenLocal
          echo "Successfully published local dry-run!"

      - name: Import GPG signing subkeys
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          test -n "$GPG_PRIVATE_KEY" || { echo "Missing GPG_PRIVATE_KEY secret"; exit 1; }
          
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          printf '%s\n' "$GPG_PRIVATE_KEY" | gpg --batch --import
        
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --reload gpg-agent
        
          gpg --list-secret-keys --keyid-format LONG

      - name: Configure publishing credentials
        run: |
          {
            echo "mavenCentralUsername=${{ secrets.SONATYPE_USERNAME }}";
            echo "mavenCentralPassword=${{ secrets.SONATYPE_PASSWORD }}";
            echo "signing.gnupg.executable=gpg";
            echo "signing.gnupg.keyName=${{ secrets.GPG_FINGERPRINT }}";
            echo "signing.gnupg.passphrase=${{ secrets.GPG_PASSPHRASE }}";
          } >> ~/.gradle/gradle.properties

      - name: Publish to Maven Central
        env:
          CENTRAL_RELEASE: "true"
          CI: "true"
          OSSRH_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        run: |
          ./gradlew clean --no-daemon publishSelectedToMavenCentral --stacktrace    
          echo "\033[0;32m"
          echo "░██████╗██╗░░░██╗░█████╗░░█████╗░███████╗░██████╗░██████╗"
          echo "██╔════╝██║░░░██║██╔══██╗██╔══██╗██╔════╝██╔════╝██╔════╝"
          echo "╚█████╗░██║░░░██║██║░░╚═╝██║░░╚═╝█████╗░░╚█████╗░╚█████╗░"
          echo "░╚═══██╗██║░░░██║██║░░██╗██║░░██╗██╔══╝░░░╚═══██╗░╚═══██╗"
          echo "██████╔╝╚██████╔╝╚█████╔╝╚█████╔╝███████╗██████╔╝██████╔╝"
          echo "╚═════╝░░╚═════╝░░╚════╝░░╚════╝░╚══════╝╚═════╝░╚═════╝░"
          echo "\033[0m"
          
          if [ -f ~/.gradle/gradle.properties ]; then
            tmp="$(mktemp)"
            grep -v -E '^[[:space:]]*(mavenCentralUsername|mavenCentralPassword|signing\.gnupg\.executable|signing\.gnupg\.keyName|signing\.gnupg\.passphrase)[[:space:]]*=' \
              ~/.gradle/gradle.properties > "$tmp"
            mv "$tmp" ~/.gradle/gradle.properties
          fi
          echo "Cleared ~/.gradle/gradle.properties"
          
          rm -rf ~/.gnupg
          echo "Cleared ~/.gnupg"